name: Push feature branches tests

on: 
  workflow_call:
    outputs:
      init-status:
        description: Status of init command
        value: ${{ jobs.check-code.outputs.output }}

env:
  TF_LOG: INFO #for getting logs in case of error
  TF_INPUT: false #disables user inputs

jobs:
  check-code:
    runs-on : ubuntu-latest

    defaults: 
      run:
        shell: bash
        working-directory: ./infrastructure
    
    outputs:
      output: ${{ steps.init.outputs.init-status}}

    steps: 
        - name: Checkout    
          uses: actions/checkout@v4

        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v3
        
        - name: Terraform init
          id: init
          run: terraform init
        
        - name: Terraform Format
          run: terraform fmt -check #checks formatting

        - name: Terraform Validate
          # Run even if formatting fails
          if: success() || failure()
          run: terraform validate -no-color #checks syntax
      
